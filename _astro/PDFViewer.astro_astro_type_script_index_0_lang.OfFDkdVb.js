class g{container;currentPage;totalPages;rendering;pdfDoc;fixedScale;isResized;constructor(e){this.container=e,this.currentPage=1,this.totalPages=0,this.rendering=!1,this.pdfDoc=null,this.fixedScale=null,this.isResized=!1,this.init()}async init(){typeof pdfjsLib>"u"&&await this.loadPDFJS(),this.bindEvents(),await this.loadPDF()}async loadPDFJS(){const e=["https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js","https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js","https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.15.349/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.min.js"],t=["https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js","https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js","https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.15.349/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.worker.min.js"];for(let i=0;i<e.length;i++)try{if(console.log(`Trying CDN ${i+1}: ${e[i]}`),await this.loadScript(e[i]),console.log(`PDF.js loaded successfully from CDN ${i+1}`),console.log(`Loading worker from: ${t[i]}`),await this.loadScript(t[i]),console.log(`PDF.js worker loaded successfully from CDN ${i+1}`),typeof pdfjsLib<"u"){console.log("‚úÖ pdfjsLib is available:",typeof pdfjsLib),console.log("‚úÖ pdfjsLib version:",pdfjsLib.version);const r=`https://cdn.jsdelivr.net/npm/pdfjs-dist@${pdfjsLib.version}/build/pdf.worker.min.js`;pdfjsLib.GlobalWorkerOptions.workerSrc=r,console.log("‚úÖ Worker configured:",r),console.log("‚úÖ GlobalWorkerOptions:",pdfjsLib.GlobalWorkerOptions)}else console.error("‚ùå pdfjsLib is not available");return}catch(r){if(console.warn(`CDN ${i+1} failed:`,r),i===e.length-1)throw new Error("All CDNs failed")}}loadScript(e){return new Promise((t,i)=>{const r=document.createElement("script");r.src=e,r.onload=()=>{console.log(`‚úÖ Script loaded successfully: ${e}`),t()},r.onerror=s=>{console.error(`‚ùå Script failed to load: ${e}`,s),i(new Error(`Failed to load: ${e}`))};const o=setTimeout(()=>{console.error(`‚è∞ Script load timeout: ${e}`),i(new Error(`Timeout loading: ${e}`))},1e4);r.onload=()=>{clearTimeout(o),console.log(`‚úÖ Script loaded successfully: ${e}`),t()},r.onerror=s=>{clearTimeout(o),console.error(`‚ùå Script failed to load: ${e}`,s),i(new Error(`Failed to load: ${e}`))},document.head.appendChild(r)})}async loadPDF(){try{const e=this.extractDriveId();if(!e)throw new Error("Drive ID not found");const t=[`/api/drive-proxy?id=${encodeURIComponent(e)}`,`https://drive.google.com/uc?export=download&id=${e}`,`https://www.googleapis.com/drive/v3/files/${e}?alt=media`];let i=null,r=null;for(let o=0;o<t.length;o++)try{console.log(`üîÑ Trying PDF source ${o+1}: ${t[o]}`);const s=await fetch(t[o],{cache:"no-store",mode:"cors",headers:{"User-Agent":"Mozilla/5.0 (compatible; PDF-Viewer/1.0)"}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const a=s.headers.get("content-type")||"";if(!a.includes("application/pdf")&&!a.includes("octet-stream")){const d=await s.text();throw console.error("Non-PDF response sample:",d.slice(0,200)),new Error("Non-PDF response")}const n=await s.arrayBuffer();i=await pdfjsLib.getDocument({data:new Uint8Array(n)}).promise,console.log(`‚úÖ PDF loaded successfully from source ${o+1}`);break}catch(s){if(console.warn(`‚ùå Source ${o+1} failed:`,s),r=s,o===t.length-1)throw r}if(!i)throw new Error("All PDF sources failed");this.pdfDoc=i,this.totalPages=i.numPages,this.currentPage=Math.min(this.currentPage,this.totalPages),this.updatePageInfo(),this.updateNavigation(),this.renderPage(),this.hideLoading()}catch(e){console.error("PDF loading failed:",e),console.log("üîÑ Activating fallback mode..."),this.showFallback()}}extractDriveId(){const e=this.container.dataset.driveUrl;if(e){const t=e.match(/\/d\/([^/]+)/);if(t)return t[1];const i=e.match(/[?&]id=([^&]+)/);if(i)return i[1];if(/^[A-Za-z0-9_-]{20,}$/.test(e))return e}return null}async renderPage(){if(!this.pdfDoc||this.rendering)return;this.rendering=!0;const e=await this.pdfDoc.getPage(this.currentPage),t=this.container.querySelector("#pdf-canvas"),i=t.getContext("2d"),r=e.getViewport({scale:1}),o=this.container.querySelector("#canvas-container"),s=o.clientWidth,a=o.clientHeight;let n;if(!this.fixedScale){if(this.isResized){const p=s/r.width,f=a/r.height;this.fixedScale=Math.min(p,f)*.9}else this.fixedScale=1;console.log("üîç Scale calculation:",{isResized:this.isResized,viewport:{width:r.width,height:r.height},container:{width:s,height:a},screen:{width:window.innerWidth,height:window.innerHeight},scale:this.fixedScale})}n=this.fixedScale;const d=e.getViewport({scale:n}),l=window.devicePixelRatio||1;t.width=Math.floor(d.width*l),t.height=Math.floor(d.height*l),t.style.width=Math.floor(d.width)+"px",t.style.height=Math.floor(d.height)+"px",i.setTransform(l,0,0,l,0,0);const h={canvasContext:i,viewport:d};await e.render(h).promise,this.updateProgress(),this.rendering=!1}prevPage(){this.currentPage>1&&(this.currentPage--,this.updatePageInfo(),this.updateNavigation(),this.renderPage())}nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.updatePageInfo(),this.updateNavigation(),this.renderPage())}updatePageInfo(){const e=this.container.querySelector("#current-page"),t=this.container.querySelector("#total-pages");e&&(e.textContent=this.currentPage.toString()),t&&(t.textContent=this.totalPages.toString())}updateNavigation(){const e=this.container.querySelector("#prev-page"),t=this.container.querySelector("#next-page");e&&(e.disabled=this.currentPage<=1),t&&(t.disabled=this.currentPage>=this.totalPages)}updateProgress(){if(!this.totalPages)return;const e=(this.currentPage-1)/(this.totalPages-1)*100,t=this.container.querySelector("#progress-bar");t&&(t.style.width=`${e}%`)}hideLoading(){const e=this.container.querySelector("#loading"),t=this.container.querySelector("#canvas-container");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")}showError(){const e=this.container.querySelector("#loading"),t=this.container.querySelector("#error");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")}showFallback(){const e=this.container.querySelector("#canvas-container");if(e){const t=this.extractDriveId();if(t){console.log("üîÑ Showing fallback for Drive ID:",t),e.innerHTML=`
            <div class="text-center p-8">
              <p class="text-gray-600 mb-4">PDF„Éì„É•„Éº„Ç¢„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
              <p class="text-sm text-gray-500 mb-6">Google Drive„ÅßÁõ¥Êé•Ë°®Á§∫„Åó„Åæ„Åô</p>
              <iframe 
                src="https://drive.google.com/file/d/${t}/preview" 
                width="100%" 
                height="600" 
                frameborder="0"
                class="border rounded-lg shadow-lg"
                allowfullscreen
                loading="lazy">
              </iframe>
              <div class="mt-4 space-y-2">
                <p class="text-xs text-gray-400">
                  <a href="https://drive.google.com/file/d/${t}/view" 
                     target="_blank" 
                     class="text-blue-600 hover:underline">
                    Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè
                  </a>
                </p>
                <p class="text-xs text-gray-400">
                  <a href="https://drive.google.com/file/d/${t}/download" 
                     target="_blank" 
                     class="text-green-600 hover:underline">
                    PDF„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                  </a>
                </p>
                <p class="text-xs text-gray-400">
                  <a href="https://drive.google.com/file/d/${t}/preview" 
                     target="_blank" 
                     class="text-purple-600 hover:underline">
                    Google Drive„ÅßÈñã„Åè
                  </a>
                </p>
              </div>
            </div>
          `;const i=e.querySelector("iframe");i&&(i.onload=()=>console.log("‚úÖ Fallback iframe loaded successfully"),i.onerror=()=>console.log("‚ùå Fallback iframe failed to load"))}else console.error("‚ùå No Drive ID found for fallback")}}retry(){const e=this.container.querySelector("#error"),t=this.container.querySelector("#loading");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden"),this.loadPDF()}bindEvents(){const e=this.container.querySelector("#prev-page"),t=this.container.querySelector("#next-page"),i=this.container.querySelector("#prev-zone"),r=this.container.querySelector("#next-zone");e?.addEventListener("click",()=>this.prevPage()),t?.addEventListener("click",()=>this.nextPage()),i?.addEventListener("click",()=>this.prevPage()),r?.addEventListener("click",()=>this.nextPage()),this.container.querySelector("#retry-button")?.addEventListener("click",()=>this.retry()),document.addEventListener("keydown",n=>{this.container.contains(document.activeElement)&&(n.key==="ArrowLeft"&&this.prevPage(),n.key==="ArrowRight"&&this.nextPage())});let s=0,a=0;this.container.addEventListener("touchstart",n=>{s=n.touches[0].clientX}),this.container.addEventListener("touchend",n=>{a=n.changedTouches[0].clientX,this.handleSwipe(s,a)}),window.addEventListener("resize",()=>{this.fixedScale=null,this.isResized=!0,console.log("üîÑ Window resized, recalculating scale..."),setTimeout(()=>{this.rendering||this.renderPage()},100)})}handleSwipe(e,t){const r=e-t;Math.abs(r)>50&&(r>0?this.nextPage():this.prevPage())}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".pdf-viewer").forEach(e=>{e instanceof HTMLElement&&new g(e)})});
