class g{container;currentPage;totalPages;rendering;pdfDoc;fixedScale;isResized;constructor(e){this.container=e,this.currentPage=1,this.totalPages=0,this.rendering=!1,this.pdfDoc=null,this.fixedScale=null,this.isResized=!1,this.init()}async init(){typeof pdfjsLib>"u"&&await this.loadPDFJS(),this.bindEvents(),await this.loadPDF()}async loadPDFJS(){const e=["https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js","https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js","https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.15.349/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.min.js"],t=["https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js","https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js","https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.15.349/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.worker.min.js"];for(let i=0;i<e.length;i++)try{if(console.log(`Trying CDN ${i+1}: ${e[i]}`),await this.loadScript(e[i]),console.log(`PDF.js loaded successfully from CDN ${i+1}`),console.log(`Loading worker from: ${t[i]}`),await this.loadScript(t[i]),console.log(`PDF.js worker loaded successfully from CDN ${i+1}`),typeof pdfjsLib<"u"){console.log("✅ pdfjsLib is available:",typeof pdfjsLib),console.log("✅ pdfjsLib version:",pdfjsLib.version);const o=`https://cdn.jsdelivr.net/npm/pdfjs-dist@${pdfjsLib.version}/build/pdf.worker.min.js`;pdfjsLib.GlobalWorkerOptions.workerSrc=o,console.log("✅ Worker configured:",o),console.log("✅ GlobalWorkerOptions:",pdfjsLib.GlobalWorkerOptions)}else console.error("❌ pdfjsLib is not available");return}catch(o){if(console.warn(`CDN ${i+1} failed:`,o),i===e.length-1)throw new Error("All CDNs failed")}}loadScript(e){return new Promise((t,i)=>{const o=document.createElement("script");o.src=e,o.onload=()=>{console.log(`✅ Script loaded successfully: ${e}`),t()},o.onerror=r=>{console.error(`❌ Script failed to load: ${e}`,r),i(new Error(`Failed to load: ${e}`))};const s=setTimeout(()=>{console.error(`⏰ Script load timeout: ${e}`),i(new Error(`Timeout loading: ${e}`))},1e4);o.onload=()=>{clearTimeout(s),console.log(`✅ Script loaded successfully: ${e}`),t()},o.onerror=r=>{clearTimeout(s),console.error(`❌ Script failed to load: ${e}`,r),i(new Error(`Failed to load: ${e}`))},document.head.appendChild(o)})}async loadPDF(){try{const e=this.extractDriveId();if(!e)throw new Error("Drive ID not found");console.log("🚀 Starting PDF loading for Drive ID:",e);const t=[`/api/drive-proxy?id=${encodeURIComponent(e)}`,`https://drive.google.com/uc?export=download&id=${e}`,`https://drive.google.com/file/d/${e}/uc?export=download`,`https://drive.google.com/file/d/${e}/view?usp=sharing`,`https://drive.google.com/file/d/${e}/preview`,`https://drive.google.com/file/d/${e}/view`];let i=null,o=null;for(let s=0;s<t.length;s++)try{console.log(`🔄 Trying PDF source ${s+1}: ${t[s]}`);const r=await fetch(t[s],{cache:"no-store",mode:"cors",headers:{"User-Agent":"Mozilla/5.0 (compatible; PDF-Viewer/1.0)"}});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const a=r.headers.get("content-type")||"";if(console.log(`📄 Content-Type: ${a}`),!a.includes("application/pdf")&&!a.includes("octet-stream")){const d=await r.text();throw console.error("Non-PDF response sample:",d.slice(0,200)),new Error("Non-PDF response")}const n=await r.arrayBuffer();console.log(`📦 ArrayBuffer size: ${n.byteLength} bytes`),i=await pdfjsLib.getDocument({data:new Uint8Array(n)}).promise,console.log(`✅ PDF loaded successfully from source ${s+1}`);break}catch(r){if(console.warn(`❌ Source ${s+1} failed:`,r),o=r,s===t.length-1)throw o}if(!i)throw new Error("All PDF sources failed");this.pdfDoc=i,this.totalPages=i.numPages,this.currentPage=Math.min(this.currentPage,this.totalPages),console.log(`📚 PDF loaded: ${this.totalPages} pages`),this.updatePageInfo(),this.updateNavigation(),this.renderPage(),this.hideLoading()}catch(e){console.error("PDF loading failed:",e),console.log("🔄 Activating fallback mode..."),this.showFallback()}}extractDriveId(){const e=this.container.dataset.driveUrl;if(e){const t=e.match(/\/d\/([^/]+)/);if(t)return t[1];const i=e.match(/[?&]id=([^&]+)/);if(i)return i[1];if(/^[A-Za-z0-9_-]{20,}$/.test(e))return e}return null}async renderPage(){if(!this.pdfDoc||this.rendering)return;this.rendering=!0;const e=await this.pdfDoc.getPage(this.currentPage),t=this.container.querySelector("#pdf-canvas"),i=t.getContext("2d"),o=e.getViewport({scale:1}),s=this.container.querySelector("#canvas-container"),r=s.clientWidth,a=s.clientHeight;let n;if(!this.fixedScale){if(this.isResized){const p=r/o.width,f=a/o.height;this.fixedScale=Math.min(p,f)*.9}else this.fixedScale=1;console.log("🔍 Scale calculation:",{isResized:this.isResized,viewport:{width:o.width,height:o.height},container:{width:r,height:a},screen:{width:window.innerWidth,height:window.innerHeight},scale:this.fixedScale})}n=this.fixedScale;const d=e.getViewport({scale:n}),l=window.devicePixelRatio||1;t.width=Math.floor(d.width*l),t.height=Math.floor(d.height*l),t.style.width=Math.floor(d.width)+"px",t.style.height=Math.floor(d.height)+"px",i.setTransform(l,0,0,l,0,0);const h={canvasContext:i,viewport:d};await e.render(h).promise,this.updateProgress(),this.rendering=!1}prevPage(){this.currentPage>1&&(this.currentPage--,this.updatePageInfo(),this.updateNavigation(),this.renderPage())}nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.updatePageInfo(),this.updateNavigation(),this.renderPage())}updatePageInfo(){const e=this.container.querySelector("#current-page"),t=this.container.querySelector("#total-pages");e&&(e.textContent=this.currentPage.toString()),t&&(t.textContent=this.totalPages.toString())}updateNavigation(){const e=this.container.querySelector("#prev-page"),t=this.container.querySelector("#next-page");e&&(e.disabled=this.currentPage<=1),t&&(t.disabled=this.currentPage>=this.totalPages)}updateProgress(){if(!this.totalPages)return;const e=(this.currentPage-1)/(this.totalPages-1)*100,t=this.container.querySelector("#progress-bar");t&&(t.style.width=`${e}%`)}hideLoading(){const e=this.container.querySelector("#loading"),t=this.container.querySelector("#canvas-container");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")}showError(){const e=this.container.querySelector("#loading"),t=this.container.querySelector("#error");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")}showFallback(){const e=this.container.querySelector("#canvas-container");if(e){const t=this.extractDriveId();if(t){console.log("🔄 Showing fallback for Drive ID:",t);const i=`https://drive.google.com/file/d/${t}/preview`;e.innerHTML=`
            <div class="text-center p-8">
              <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <p class="text-xs text-gray-400">💡 共有設定が「リンクを知っている全員」になっているか確認してください</p>
                <p class="text-xs text-gray-400">🚀 PDFビューアーを動作させるには、ファイルの共有設定を「全員」に変更してください</p>
              </div>
              <iframe 
                src="${i}" 
                width="100%" 
                height="600" 
                frameborder="0"
                class="border rounded-lg shadow-lg"
                allowfullscreen
                loading="lazy">
              </iframe>
            </div>
          `;const o=e.querySelector("iframe");o&&(o.onload=()=>console.log("✅ Fallback iframe loaded successfully"),o.onerror=()=>console.log("❌ Fallback iframe failed to load"))}else console.error("❌ No Drive ID found for fallback")}}retry(){const e=this.container.querySelector("#error"),t=this.container.querySelector("#loading");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden"),this.loadPDF()}bindEvents(){const e=this.container.querySelector("#prev-page"),t=this.container.querySelector("#next-page"),i=this.container.querySelector("#prev-zone"),o=this.container.querySelector("#next-zone");e?.addEventListener("click",()=>this.prevPage()),t?.addEventListener("click",()=>this.nextPage()),i?.addEventListener("click",()=>this.prevPage()),o?.addEventListener("click",()=>this.nextPage()),this.container.querySelector("#retry-button")?.addEventListener("click",()=>this.retry()),document.addEventListener("keydown",n=>{this.container.contains(document.activeElement)&&(n.key==="ArrowLeft"&&this.prevPage(),n.key==="ArrowRight"&&this.nextPage())});let r=0,a=0;this.container.addEventListener("touchstart",n=>{r=n.touches[0].clientX}),this.container.addEventListener("touchend",n=>{a=n.changedTouches[0].clientX,this.handleSwipe(r,a)}),window.addEventListener("resize",()=>{this.fixedScale=null,this.isResized=!0,console.log("🔄 Window resized, recalculating scale..."),setTimeout(()=>{this.rendering||this.renderPage()},100)})}handleSwipe(e,t){const o=e-t;Math.abs(o)>50&&(o>0?this.nextPage():this.prevPage())}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".pdf-viewer").forEach(e=>{e instanceof HTMLElement&&new g(e)})});
