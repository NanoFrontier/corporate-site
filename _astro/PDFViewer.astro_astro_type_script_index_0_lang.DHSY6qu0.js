class g{container;currentPage;totalPages;rendering;pdfDoc;fixedScale;isResized;constructor(e){this.container=e,this.currentPage=1,this.totalPages=0,this.rendering=!1,this.pdfDoc=null,this.fixedScale=null,this.isResized=!1,this.init()}async init(){typeof pdfjsLib>"u"&&await this.loadPDFJS(),this.bindEvents(),await this.loadPDF()}async loadPDFJS(){const e=["https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js","https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js","https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.15.349/build/pdf.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.min.js"],t=["https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js","https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js","https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.15.349/build/pdf.worker.min.js","https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.worker.min.js"];for(let i=0;i<e.length;i++)try{if(console.log(`Trying CDN ${i+1}: ${e[i]}`),await this.loadScript(e[i]),console.log(`PDF.js loaded successfully from CDN ${i+1}`),console.log(`Loading worker from: ${t[i]}`),await this.loadScript(t[i]),console.log(`PDF.js worker loaded successfully from CDN ${i+1}`),typeof pdfjsLib<"u"){console.log("✅ pdfjsLib is available:",typeof pdfjsLib),console.log("✅ pdfjsLib version:",pdfjsLib.version);const r=`https://cdn.jsdelivr.net/npm/pdfjs-dist@${pdfjsLib.version}/build/pdf.worker.min.js`;pdfjsLib.GlobalWorkerOptions.workerSrc=r,console.log("✅ Worker configured:",r),console.log("✅ GlobalWorkerOptions:",pdfjsLib.GlobalWorkerOptions)}else console.error("❌ pdfjsLib is not available");return}catch(r){if(console.warn(`CDN ${i+1} failed:`,r),i===e.length-1)throw new Error("All CDNs failed")}}loadScript(e){return new Promise((t,i)=>{const r=document.createElement("script");r.src=e,r.onload=()=>{console.log(`✅ Script loaded successfully: ${e}`),t()},r.onerror=n=>{console.error(`❌ Script failed to load: ${e}`,n),i(new Error(`Failed to load: ${e}`))};const o=setTimeout(()=>{console.error(`⏰ Script load timeout: ${e}`),i(new Error(`Timeout loading: ${e}`))},1e4);r.onload=()=>{clearTimeout(o),console.log(`✅ Script loaded successfully: ${e}`),t()},r.onerror=n=>{clearTimeout(o),console.error(`❌ Script failed to load: ${e}`,n),i(new Error(`Failed to load: ${e}`))},document.head.appendChild(r)})}async loadPDF(){try{const e=this.extractDriveId();if(!e)throw new Error("Drive ID not found");const t=`/api/drive-proxy?id=${encodeURIComponent(e)}`,i=await fetch(t,{cache:"no-store"});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);if(!(i.headers.get("content-type")||"").includes("application/pdf")){const a=await i.text();throw console.error("Non-PDF response sample:",a.slice(0,200)),new Error("Non-PDF response from proxy")}const o=await i.arrayBuffer(),n=await pdfjsLib.getDocument({data:new Uint8Array(o)}).promise;this.pdfDoc=n,this.totalPages=n.numPages,this.currentPage=Math.min(this.currentPage,this.totalPages),this.updatePageInfo(),this.updateNavigation(),this.renderPage(),this.hideLoading()}catch(e){console.error("PDF loading failed:",e),console.log("🔄 Activating fallback mode..."),this.showFallback()}}extractDriveId(){const e=this.container.dataset.driveUrl;if(e){const t=e.match(/\/d\/([^/]+)/);if(t)return t[1];const i=e.match(/[?&]id=([^&]+)/);if(i)return i[1];if(/^[A-Za-z0-9_-]{20,}$/.test(e))return e}return null}async renderPage(){if(!this.pdfDoc||this.rendering)return;this.rendering=!0;const e=await this.pdfDoc.getPage(this.currentPage),t=this.container.querySelector("#pdf-canvas"),i=t.getContext("2d"),r=e.getViewport({scale:1}),o=this.container.querySelector("#canvas-container"),n=o.clientWidth,a=o.clientHeight;let s;if(!this.fixedScale){if(this.isResized){const p=n/r.width,f=a/r.height;this.fixedScale=Math.min(p,f)*.9}else this.fixedScale=1;console.log("🔍 Scale calculation:",{isResized:this.isResized,viewport:{width:r.width,height:r.height},container:{width:n,height:a},screen:{width:window.innerWidth,height:window.innerHeight},scale:this.fixedScale})}s=this.fixedScale;const d=e.getViewport({scale:s}),c=window.devicePixelRatio||1;t.width=Math.floor(d.width*c),t.height=Math.floor(d.height*c),t.style.width=Math.floor(d.width)+"px",t.style.height=Math.floor(d.height)+"px",i.setTransform(c,0,0,c,0,0);const h={canvasContext:i,viewport:d};await e.render(h).promise,this.updateProgress(),this.rendering=!1}prevPage(){this.currentPage>1&&(this.currentPage--,this.updatePageInfo(),this.updateNavigation(),this.renderPage())}nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.updatePageInfo(),this.updateNavigation(),this.renderPage())}updatePageInfo(){const e=this.container.querySelector("#current-page"),t=this.container.querySelector("#total-pages");e&&(e.textContent=this.currentPage.toString()),t&&(t.textContent=this.totalPages.toString())}updateNavigation(){const e=this.container.querySelector("#prev-page"),t=this.container.querySelector("#next-page");e&&(e.disabled=this.currentPage<=1),t&&(t.disabled=this.currentPage>=this.totalPages)}updateProgress(){if(!this.totalPages)return;const e=(this.currentPage-1)/(this.totalPages-1)*100,t=this.container.querySelector("#progress-bar");t&&(t.style.width=`${e}%`)}hideLoading(){const e=this.container.querySelector("#loading"),t=this.container.querySelector("#canvas-container");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")}showError(){const e=this.container.querySelector("#loading"),t=this.container.querySelector("#error");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")}showFallback(){const e=this.container.querySelector("#canvas-container");if(e){const t=this.extractDriveId();if(t){console.log("🔄 Showing fallback for Drive ID:",t),e.innerHTML=`
            <div class="text-center p-8">
              <p class="text-gray-600 mb-4">PDFビューアーの読み込みに失敗しました</p>
              <p class="text-sm text-gray-500 mb-6">Google Driveで直接表示します</p>
              <iframe 
                src="https://drive.google.com/file/d/${t}/preview" 
                width="100%" 
                height="600" 
                frameborder="0"
                class="border rounded-lg shadow-lg"
                allowfullscreen
                loading="lazy">
              </iframe>
              <div class="mt-4 space-y-2">
                <p class="text-xs text-gray-400">
                  <a href="https://drive.google.com/file/d/${t}/view" 
                     target="_blank" 
                     class="text-blue-600 hover:underline">
                    新しいタブで開く
                  </a>
                </p>
                <p class="text-xs text-gray-400">
                  <a href="https://drive.google.com/file/d/${t}/download" 
                     target="_blank" 
                     class="text-green-600 hover:underline">
                    PDFをダウンロード
                  </a>
                </p>
                <p class="text-xs text-gray-400">
                  <a href="/api/drive-proxy?id=${t}" 
                     target="_blank" 
                     class="text-purple-600 hover:underline">
                    プロキシ経由で開く
                  </a>
                </p>
              </div>
            </div>
          `;const i=e.querySelector("iframe");i.onload=()=>console.log("✅ Fallback iframe loaded successfully"),i.onerror=()=>console.log("❌ Fallback iframe failed to load")}else console.error("❌ No Drive ID found for fallback")}}retry(){const e=this.container.querySelector("#error"),t=this.container.querySelector("#loading");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden"),this.loadPDF()}bindEvents(){const e=this.container.querySelector("#prev-page"),t=this.container.querySelector("#next-page"),i=this.container.querySelector("#prev-zone"),r=this.container.querySelector("#next-zone");e?.addEventListener("click",()=>this.prevPage()),t?.addEventListener("click",()=>this.nextPage()),i?.addEventListener("click",()=>this.prevPage()),r?.addEventListener("click",()=>this.nextPage()),this.container.querySelector("#retry-button")?.addEventListener("click",()=>this.retry()),document.addEventListener("keydown",s=>{this.container.contains(document.activeElement)&&(s.key==="ArrowLeft"&&this.prevPage(),s.key==="ArrowRight"&&this.nextPage())});let n=0,a=0;this.container.addEventListener("touchstart",s=>{n=s.touches[0].clientX}),this.container.addEventListener("touchend",s=>{a=s.changedTouches[0].clientX,this.handleSwipe(n,a)}),window.addEventListener("resize",()=>{this.fixedScale=null,this.isResized=!0,console.log("🔄 Window resized, recalculating scale..."),setTimeout(()=>{this.rendering||this.renderPage()},100)})}handleSwipe(e,t){const r=e-t;Math.abs(r)>50&&(r>0?this.nextPage():this.prevPage())}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".pdf-viewer").forEach(e=>{e instanceof HTMLElement&&new g(e)})});
