---
interface Props {
  title: string;
  description: string;
  driveUrl: string;
  className?: string;
}

const { title, description, driveUrl, className = "" } = Astro.props;

// Google Driveã®ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’æŠ½å‡º
function extractDriveId(url: string): string | null {
  // ä¾‹: https://drive.google.com/file/d/FILE_ID/view?usp=sharing
  const m1 = url.match(/\/d\/([^/]+)/);
  if (m1) return m1[1];
  // ä¾‹: https://drive.google.com/open?id=FILE_ID
  const m2 = url.match(/[?&]id=([^&]+)/);
  if (m2) return m2[1];
  // ä¾‹: ç›´æ¥ID
  if (/^[A-Za-z0-9_-]{20,}$/.test(url)) return url;
  return null;
}

const driveId = extractDriveId(driveUrl);
---

<div class={`pdf-viewer bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden mt-12 mb-12 ${className}`} data-drive-url={driveUrl}>
  <!-- Header -->
  <div class="bg-gradient-to-r from-[#04666c] to-[#035458] text-white p-4 sm:p-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div class="flex items-center space-x-3 sm:space-x-4 min-w-0">
        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
          <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </div>
        <div class="min-w-0 flex-1">
          <h3 class="text-lg sm:text-xl font-bold truncate">{title}</h3>
          <p class="text-white/80 text-sm truncate">{description}</p>
        </div>
      </div>
      <div class="flex items-center space-x-2 flex-shrink-0">
        <a 
          href={`https://drive.google.com/file/d/${driveId}/view`}
          class="bg-white/20 hover:bg-white/30 text-white px-3 py-2 sm:px-4 sm:py-2 rounded-lg transition-colors flex items-center space-x-2 text-sm"
          target="_blank"
          rel="noopener noreferrer"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
          <span>Driveã§é–‹ã</span>
        </a>
      </div>
    </div>
  </div>

  <!-- PDF Viewer Container -->
  <div class="relative bg-gray-50" id="pdf-container">
    <!-- Navigation Bar -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 sm:p-4 bg-white border-b border-gray-200 gap-3 sm:gap-0">    
    <!-- PDF Canvas Container -->
    <div class="relative bg-white flex items-center justify-center min-h-[600px]" id="pdf-viewer">
      <div class="absolute inset-0 flex flex-col items-center justify-center text-center text-gray-500" id="loading">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-[#04666c] mb-6"></div>
        <p class="text-lg font-medium">PDFã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        <p class="text-sm text-gray-400 mt-2">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
      </div>
      
      <div class="hidden" id="canvas-container">
        <canvas id="pdf-canvas" class="max-w-full max-h-full shadow-lg"></canvas>
        
        <!-- Navigation Zones -->
        <div class="absolute inset-0 pointer-events-none">
          <div class="absolute left-0 top-0 bottom-0 w-1/3 cursor-pointer hover:bg-black/5 transition-colors" id="prev-zone" title="å‰ã®ãƒšãƒ¼ã‚¸"></div>
          <div class="absolute right-0 top-0 bottom-0 w-1/3 cursor-pointer hover:bg-black/5 transition-colors" id="next-zone" title="æ¬¡ã®ãƒšãƒ¼ã‚¸"></div>
        </div>
      </div>
      
      <div class="hidden text-center text-gray-500" id="error">
        <svg class="w-16 h-16 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
        <p class="text-lg font-semibold mb-2">PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
        <p class="text-sm mb-4">ãƒ•ã‚¡ã‚¤ãƒ«ã®å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
        <div class="space-y-2 text-xs">
          <p>â€¢ Google Driveã®å…±æœ‰è¨­å®šãŒã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª</p>
          <p>â€¢ ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª</p>
          <p>â€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª</p>
        </div>
        <button 
          class="mt-4 bg-[#04666c] hover:bg-[#035458] text-white px-4 py-2 rounded-lg transition-colors text-sm"
          id="retry-button"
        >
          å†è©¦è¡Œ
        </button>
      </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="h-1 bg-gray-200">
      <div class="h-full bg-[#04666c] transition-all duration-300" id="progress-bar" style="width: 0%"></div>
    </div>
  </div>
     <!-- Page Navigation Section (Centered) -->
   <div class="flex items-center justify-center space-x-3 sm:space-x-4 p-4 bg-white border-t border-gray-200">
     <button 
       class="p-2 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
       id="prev-page"
       disabled
     >
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
       </svg>
     </button>
     
     <div class="flex items-center space-x-2">
       <span class="text-sm text-gray-600">ãƒšãƒ¼ã‚¸:</span>
       <span class="text-sm font-medium" id="current-page">1</span>
       <span class="text-sm text-gray-400">/</span>
       <span class="text-sm text-gray-600" id="total-pages">-</span>
     </div>
     
     <button 
       class="p-2 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
       id="next-page"
     >
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
       </svg>
     </button>
   </div>
</div>
</div>

<script>
  class PDFViewer {
    private container: HTMLElement;
    private currentPage: number;
    private totalPages: number;
    private rendering: boolean;
    private pdfDoc: any;
    private fixedScale: number | null;
    private isResized: boolean;
    
    constructor(container: HTMLElement) {
      this.container = container;
      this.currentPage = 1;
      this.totalPages = 0;
      this.rendering = false;
      this.pdfDoc = null;
      this.fixedScale = null;
      this.isResized = false;
      
      this.init();
    }
    
    async init() {
      if (typeof pdfjsLib === 'undefined') {
        await this.loadPDFJS();
      }
      
      this.bindEvents();
      await this.loadPDF();
    }
    
    async loadPDFJS() {
      const cdnUrls = [
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js',
        'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/build/pdf.min.js',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/build/pdf.min.js',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.15.349/build/pdf.min.js',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.min.js'
      ];
      
      const workerUrls = [
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js',
        'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/build/pdf.worker.min.js',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.10.111/build/pdf.worker.min.js',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.15.349/build/pdf.worker.min.js',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.worker.min.js'
      ];
      
      for (let i = 0; i < cdnUrls.length; i++) {
        try {
          console.log(`Trying CDN ${i + 1}: ${cdnUrls[i]}`);
          await this.loadScript(cdnUrls[i]);
          console.log(`PDF.js loaded successfully from CDN ${i + 1}`);
          
          console.log(`Loading worker from: ${workerUrls[i]}`);
          await this.loadScript(workerUrls[i]);
          console.log(`PDF.js worker loaded successfully from CDN ${i + 1}`);
          
                  // PDF.jsã®èª­ã¿è¾¼ã¿ç¢ºèª
        if (typeof pdfjsLib !== 'undefined') {
          console.log('âœ… pdfjsLib is available:', typeof pdfjsLib);
          console.log('âœ… pdfjsLib version:', pdfjsLib.version);
          
          // Workerã®è¨­å®šã‚’ç¢ºå®Ÿã«è¡Œã†
          const workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@${pdfjsLib.version}/build/pdf.worker.min.js`;
          pdfjsLib.GlobalWorkerOptions.workerSrc = workerSrc;
          console.log('âœ… Worker configured:', workerSrc);
          console.log('âœ… GlobalWorkerOptions:', pdfjsLib.GlobalWorkerOptions);
        } else {
          console.error('âŒ pdfjsLib is not available');
        }
          
          return; // æˆåŠŸã—ãŸã‚‰çµ‚äº†
        } catch (error) {
          console.warn(`CDN ${i + 1} failed:`, error);
          if (i === cdnUrls.length - 1) {
            throw new Error('All CDNs failed');
          }
        }
      }
    }
    
    loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        
        script.onload = () => {
          console.log(`âœ… Script loaded successfully: ${src}`);
          resolve();
        };
        
        script.onerror = (error) => {
          console.error(`âŒ Script failed to load: ${src}`, error);
          reject(new Error(`Failed to load: ${src}`));
        };
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10ç§’ï¼‰
        const timeout = setTimeout(() => {
          console.error(`â° Script load timeout: ${src}`);
          reject(new Error(`Timeout loading: ${src}`));
        }, 10000);
        
        script.onload = () => {
          clearTimeout(timeout);
          console.log(`âœ… Script loaded successfully: ${src}`);
          resolve();
        };
        
        script.onerror = (error) => {
          clearTimeout(timeout);
          console.error(`âŒ Script failed to load: ${src}`, error);
          reject(new Error(`Failed to load: ${src}`));
        };
        
        document.head.appendChild(script);
      });
    }
    
    async loadPDF() {
      try {
        const driveId = this.extractDriveId();
        if (!driveId) {
          throw new Error('Drive ID not found');
        }
        
        // è‡ªå‰ãƒ—ãƒ­ã‚­ã‚·APIã‚’ä½¿ç”¨ã—ã¦ç´”ç²‹ãªPDFãƒã‚¤ãƒˆã‚’å–å¾—
        const pdfUrl = `/api/drive-proxy?id=${encodeURIComponent(driveId)}`;
        
        // workerSrcã¯æ—¢ã«loadPDFJSã§è¨­å®šæ¸ˆã¿
        // pdfjsLib.GlobalWorkerOptions.workerSrc = '...';
        
        // fetchâ†’ArrayBufferæ–¹å¼ã§ç¢ºå®Ÿã«PDFã‚’å–å¾—
        const response = await fetch(pdfUrl, { 
          cache: 'no-store'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // Content-Typeã‚’ç¢ºèª
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/pdf')) {
          const text = await response.text();
          console.error('Non-PDF response sample:', text.slice(0, 200));
          throw new Error('Non-PDF response from proxy');
        }
        
        const arrayBuffer = await response.arrayBuffer();
        
        // ArrayBufferã‚’Uint8Arrayã«å¤‰æ›ã—ã¦PDF.jsã«æ¸¡ã™
        const pdf = await pdfjsLib.getDocument({
          data: new Uint8Array(arrayBuffer)
        }).promise;
        
        this.pdfDoc = pdf;
        this.totalPages = pdf.numPages;
        this.currentPage = Math.min(this.currentPage, this.totalPages);
        
        this.updatePageInfo();
        this.updateNavigation();
        this.renderPage();
        this.hideLoading();
        
              } catch (error) {
          console.error('PDF loading failed:', error);
          console.log('ğŸ”„ Activating fallback mode...');
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Google Driveã®ç›´æ¥åŸ‹ã‚è¾¼ã¿ã‚’è¡¨ç¤º
          this.showFallback();
        }
    }
    
    extractDriveId() {
      // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®propsã‹ã‚‰ç›´æ¥å–å¾—
      const driveUrl = this.container.dataset.driveUrl;
      if (driveUrl) {
        const m1 = driveUrl.match(/\/d\/([^/]+)/);
        if (m1) return m1[1];
        const m2 = driveUrl.match(/[?&]id=([^&]+)/);
        if (m2) return m2[1];
        if (/^[A-Za-z0-9_-]{20,}$/.test(driveUrl)) return driveUrl;
      }
      return null;
    }
    
    async renderPage() {
      if (!this.pdfDoc || this.rendering) return;
      
      this.rendering = true;
      const page = await this.pdfDoc.getPage(this.currentPage);
      
      const canvas = this.container.querySelector('#pdf-canvas');
      const ctx = canvas.getContext('2d');
      
      const viewport = page.getViewport({ scale: 1 });
      const container = this.container.querySelector('#canvas-container');
      const containerWidth = container.clientWidth;
      const containerHeight = container.clientHeight;
      
      // å¸¸ã«æœ€å¤§ã‚µã‚¤ã‚ºã§è¡¨ç¤ºã™ã‚‹ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
      let scale;
      
      // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’æ¯”ç‡ç¶­æŒã—ãªãŒã‚‰ãƒ•ã‚£ãƒƒãƒˆã™ã‚‹ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—ï¼ˆãƒšãƒ¼ã‚¸ã”ã¨ã«å›ºå®šï¼‰
      if (!this.fixedScale) {
        // åˆå›ã¯100%ã§é–‹å§‹ã€ãƒªã‚µã‚¤ã‚ºå¾Œã¯é©åˆ‡ã«è¨ˆç®—
        if (this.isResized) {
          // ãƒªã‚µã‚¤ã‚ºå¾Œã¯ç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦è¨ˆç®—
          const scaleX = containerWidth / viewport.width;
          const scaleY = containerHeight / viewport.height;
          this.fixedScale = Math.min(scaleX, scaleY) * 0.9; // 90%ã§ä½™ç™½ç¢ºä¿
        } else {
          // åˆå›ã¯100%ã§é–‹å§‹
          this.fixedScale = 1.0;
        }
        
        console.log('ğŸ” Scale calculation:', {
          isResized: this.isResized,
          viewport: { width: viewport.width, height: viewport.height },
          container: { width: containerWidth, height: containerHeight },
          screen: { width: window.innerWidth, height: window.innerHeight },
          scale: this.fixedScale
        });
      }
      
      // å›ºå®šã•ã‚ŒãŸã‚¹ã‚±ãƒ¼ãƒ«ã‚’ä½¿ç”¨
      scale = this.fixedScale;
      
      const scaledViewport = page.getViewport({ scale });
      const dpr = window.devicePixelRatio || 1;
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
      canvas.width = Math.floor(scaledViewport.width * dpr);
      canvas.height = Math.floor(scaledViewport.height * dpr);
      canvas.style.width = Math.floor(scaledViewport.width) + 'px';
      canvas.style.height = Math.floor(scaledViewport.height) + 'px';
      
      // é«˜è§£åƒåº¦ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œ
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      
      const renderContext = {
        canvasContext: ctx,
        viewport: scaledViewport
      };
      
      await page.render(renderContext).promise;
      
      this.updateProgress();
      this.rendering = false;
    }
    
    prevPage() {
      if (this.currentPage > 1) {
        this.currentPage--;
        this.updatePageInfo();
        this.updateNavigation();
        this.renderPage();
      }
    }
    
    nextPage() {
      if (this.currentPage < this.totalPages) {
        this.currentPage++;
        this.updatePageInfo();
        this.updateNavigation();
        this.renderPage();
      }
    }
    
    updatePageInfo() {
      const currentPageEl = this.container.querySelector('#current-page');
      const totalPagesEl = this.container.querySelector('#total-pages');
      
      if (currentPageEl) currentPageEl.textContent = this.currentPage.toString();
      if (totalPagesEl) totalPagesEl.textContent = this.totalPages.toString();
    }
    
    updateNavigation() {
      const prevBtn = this.container.querySelector('#prev-page');
      const nextBtn = this.container.querySelector('#next-page');
      
      if (prevBtn) prevBtn.disabled = this.currentPage <= 1;
      if (nextBtn) nextBtn.disabled = this.currentPage >= this.totalPages;
    }
    
    updateProgress() {
      if (!this.totalPages) return;
      
      const progress = ((this.currentPage - 1) / (this.totalPages - 1)) * 100;
      const progressBar = this.container.querySelector('#progress-bar');
      if (progressBar) progressBar.style.width = `${progress}%`;
    }
    

    

    
    hideLoading() {
      const loading = this.container.querySelector('#loading');
      const canvasContainer = this.container.querySelector('#canvas-container');
      if (loading) loading.classList.add('hidden');
      if (canvasContainer) canvasContainer.classList.remove('hidden');
    }
    
    showError() {
      const loading = this.container.querySelector('#loading');
      const error = this.container.querySelector('#error');
      if (loading) loading.classList.add('hidden');
      if (error) error.classList.remove('hidden');
    }
    
    showFallback() {
      const canvasContainer = this.container.querySelector('#canvas-container');
      if (canvasContainer) {
        const driveId = this.extractDriveId();
        if (driveId) {
          console.log('ğŸ”„ Showing fallback for Drive ID:', driveId);
          canvasContainer.innerHTML = `
            <div class="text-center p-8">
              <p class="text-gray-600 mb-4">PDFãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
              <p class="text-sm text-gray-500 mb-6">Google Driveã§ç›´æ¥è¡¨ç¤ºã—ã¾ã™</p>
              <iframe 
                src="https://drive.google.com/file/d/${driveId}/preview" 
                width="100%" 
                height="600" 
                frameborder="0"
                class="border rounded-lg shadow-lg"
                allowfullscreen
                loading="lazy">
              </iframe>
              <div class="mt-4 space-y-2">
                <p class="text-xs text-gray-400">
                  <a href="https://drive.google.com/file/d/${driveId}/view" 
                     target="_blank" 
                     class="text-blue-600 hover:underline">
                    æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                  </a>
                </p>
                <p class="text-xs text-gray-400">
                  <a href="https://drive.google.com/file/d/${driveId}/download" 
                     target="_blank" 
                     class="text-green-600 hover:underline">
                    PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                  </a>
                </p>
                <p class="text-xs text-gray-400">
                  <a href="/api/drive-proxy?id=${driveId}" 
                     target="_blank" 
                     class="text-purple-600 hover:underline">
                    ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§é–‹ã
                  </a>
                </p>
              </div>
            </div>
          `;
          
          // iframeã®èª­ã¿è¾¼ã¿ç¢ºèª
          const iframe = canvasContainer.querySelector('iframe');
          iframe.onload = () => console.log('âœ… Fallback iframe loaded successfully');
          iframe.onerror = () => console.log('âŒ Fallback iframe failed to load');
        } else {
          console.error('âŒ No Drive ID found for fallback');
        }
      }
    }
    
    retry() {
      const error = this.container.querySelector('#error');
      const loading = this.container.querySelector('#loading');
      if (error) error.classList.add('hidden');
      if (loading) loading.classList.remove('hidden');
      
      // å†èª­ã¿è¾¼ã¿
      this.loadPDF();
    }
    
    bindEvents() {
      const prevBtn = this.container.querySelector('#prev-page');
      const nextBtn = this.container.querySelector('#next-page');
      const prevZone = this.container.querySelector('#prev-zone');
      const nextZone = this.container.querySelector('#next-zone');
      
      prevBtn?.addEventListener('click', () => this.prevPage());
      nextBtn?.addEventListener('click', () => this.nextPage());
      prevZone?.addEventListener('click', () => this.prevPage());
      nextZone?.addEventListener('click', () => this.nextPage());
      
      // å†è©¦è¡Œãƒœã‚¿ãƒ³
      const retryBtn = this.container.querySelector('#retry-button');
      retryBtn?.addEventListener('click', () => this.retry());
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (this.container.contains(document.activeElement)) {
          if (e.key === 'ArrowLeft') this.prevPage();
          if (e.key === 'ArrowRight') this.nextPage();
        }
      });
      
      // Touch/swipe support
      let startX = 0;
      let endX = 0;
      
      this.container.addEventListener('touchstart', (e: TouchEvent) => {
        startX = e.touches[0].clientX;
      });
      
      this.container.addEventListener('touchend', (e: TouchEvent) => {
        endX = e.changedTouches[0].clientX;
        this.handleSwipe(startX, endX);
      });
      
      // Resize handling
      window.addEventListener('resize', () => {
        // ãƒªã‚µã‚¤ã‚ºæ™‚ã¯ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å†è¨ˆç®—
        this.fixedScale = null;
        this.isResized = true; // ãƒªã‚µã‚¤ã‚ºãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        console.log('ğŸ”„ Window resized, recalculating scale...');
        
        // å°‘ã—é…å»¶ã•ã›ã¦ãƒªã‚µã‚¤ã‚ºå®Œäº†ã‚’å¾…ã¤
        setTimeout(() => {
          if (!this.rendering) {
            this.renderPage();
          }
        }, 100);
      });
    }
    
    handleSwipe(startX: number, endX: number) {
      const threshold = 50;
      const diff = startX - endX;
      
      if (Math.abs(diff) > threshold) {
        if (diff > 0) {
          this.nextPage();
        } else {
          this.prevPage();
        }
      }
    }
  }
  
  // Initialize PDF viewers
  document.addEventListener('DOMContentLoaded', () => {
    const viewers = document.querySelectorAll('.pdf-viewer');
    viewers.forEach(viewer => {
      if (viewer instanceof HTMLElement) {
        new PDFViewer(viewer);
      }
    });
  });
</script>

<style>
  .pdf-viewer {
    transition: all 0.3s ease;
    width: 100%;
    max-width: 1400px; /* æœ€å¤§å¹…ã‚’åˆ¶é™ */
    margin: 0 auto; /* ä¸­å¤®æƒãˆ */
  }
  
  .pdf-viewer:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }
  
  #pdf-container {
    transition: all 0.3s ease;
    width: 100%;
  }
  

  
  #pdf-viewer {
    width: 100%;
    min-height: 60vh; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”»é¢ã®60%ã«å‰Šæ¸› */
    max-height: 75vh; /* æœ€å¤§é«˜ã•ã‚‚åˆ¶é™ */
    padding: 0; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å®Œå…¨ã«æ’é™¤ */
    margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’å®Œå…¨ã«æ’é™¤ */
  }
  
  /* ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã®æœ€é©åŒ– */
  @media (max-width: 768px) {
    #pdf-viewer {
      min-height: 50vh; /* ã‚¹ãƒãƒ›ã§ã¯å°‘ã—å°ã•ã */
      max-height: 70vh; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
    }
  }
  
  @media (min-width: 1201px) {
    #pdf-viewer {
      min-height: 70vh; /* PCã§ã¯å¤§ããè¡¨ç¤º */
      max-height: 80vh; /* ä½™ç™½ã‚’æœ€å°é™ã« */
    }
  }
  
  #canvas-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%; /* è¦ªè¦ç´ ã«åˆã‚ã›ã‚‹ */
    min-height: 350px; /* æœ€å°é«˜ã•ã‚’å‰Šæ¸› */
    overflow: auto; /* ã‚¹ãƒ©ã‚¤ãƒ‰ãŒå¤§ãã„æ™‚ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ */
    padding: 1rem; /* é©åº¦ãªãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ  */
    margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’å®Œå…¨ã«æ’é™¤ */
  }
  
  /* ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã®æœ€é©åŒ– */
  @media (max-width: 768px) {
    #canvas-container {
      overflow: auto; /* ã‚¹ãƒãƒ›ã§ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼ˆæ¯”ç‡ç¶­æŒã®ãŸã‚ï¼‰ */
      align-items: center; /* ä¸­å¤®æƒãˆã§è¡¨ç¤º */
      padding: 0.5rem; /* ã‚¹ãƒãƒ›ã§ã¯å°ã•ã‚ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
      margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’å®Œå…¨ã«æ’é™¤ */
    }
  }
  
  @media (min-width: 1201px) {
    #canvas-container {
      overflow: auto; /* PCã§ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼ˆæ¯”ç‡ç¶­æŒã®ãŸã‚ï¼‰ */
      align-items: center; /* ä¸­å¤®æƒãˆã§è¡¨ç¤º */
      padding: 2rem; /* PCã§ã¯å¤§ãã‚ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã§ä½™ç™½ã‚’ç¢ºä¿ */
    }
  }
  
  #pdf-canvas {
    border-radius: 0; /* è§’ä¸¸ã‚’å‰Šé™¤ */
    box-shadow: none; /* å½±ã‚’å‰Šé™¤ */
    max-width: none; /* æœ€å¤§å¹…åˆ¶é™ã‚’è§£é™¤ï¼ˆæ¯”ç‡ç¶­æŒã®ãŸã‚ï¼‰ */
    max-height: none; /* æœ€å¤§é«˜ã•åˆ¶é™ã‚’è§£é™¤ï¼ˆæ¯”ç‡ç¶­æŒã®ãŸã‚ï¼‰ */
    padding: 0; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å®Œå…¨ã«æ’é™¤ */
    margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’å®Œå…¨ã«æ’é™¤ */
  }
  
  /* Responsive adjustments */
  @media (max-width: 1200px) {
    .pdf-viewer {
      max-width: 100%;
      margin: 0 1rem; /* å·¦å³ãƒãƒ¼ã‚¸ãƒ³ã‚’ä¸€å®šã« */
    }
    
    #pdf-viewer {
      min-height: 55vh; /* é«˜ã•ã‚’å‰Šæ¸› */
    }
  }
  
  @media (max-width: 768px) {
    .pdf-viewer {
      margin: 0 1rem; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ä¸€å®šã«ä¿ã¤ */
      border-radius: 8px;
    }
    
    #pdf-viewer {
      min-height: 35vh; /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã¯ã•ã‚‰ã«é«˜ã•ã‚’å‰Šæ¸› */
    }
    
    #canvas-container {
      min-height: 280px;
    }
  }
  
  @media (max-width: 480px) {
    .pdf-viewer {
      margin: 0 0.75rem; /* å°ã•ã„ç”»é¢ã§ã‚‚ãƒãƒ¼ã‚¸ãƒ³ã‚’ä¿ã¤ */
    }
    
    #pdf-viewer {
      min-height: 25vh; /* ã‚¹ãƒãƒ›ã§ã¯å¤§å¹…ã«é«˜ã•ã‚’å‰Šæ¸› */
    }
    
    #canvas-container {
      min-height: 200px; /* æœ€å°é«˜ã•ã‚‚å‰Šæ¸› */
    }
  }
  
  @media (max-width: 360px) {
    .pdf-viewer {
      margin: 0 0.5rem; /* æœ€å°ãƒãƒ¼ã‚¸ãƒ³ */
    }
    
    #pdf-viewer {
      min-height: 20vh; /* å°ã•ã„ã‚¹ãƒãƒ›ã§ã¯ã•ã‚‰ã«å‰Šæ¸› */
    }
    
    #canvas-container {
      min-height: 150px;
    }
  }
</style>
